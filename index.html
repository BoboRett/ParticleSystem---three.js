<!DOCTYPE html><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
	<title>Particle Test</title>
</head>
<body>
    <div class="page">
    </div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/97/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.3/dat.gui.min.js"></script>
    <script src="https://rawgit.com/mrdoob/three.js/master/examples/js/controls/TrackballControls.js"></script>
    <!--<script src="https://rawgit.com/mrdoob/three.js/master/examples/js/GPUComputationRenderer.js"></script>-->
	<script src="https://rawgit.com/mrdoob/stats.js/master/build/stats.min.js"></script>
	<script src="GPUParticles_Compute.js"></script>
	<script src="GPUComputationRenderer.js"></script>

    <script>
    var camera, runTime = 0,
        scene, renderer, clock = new THREE.Clock(),
        controls, container,
        options, spawnerOptions, particleSystem;

    let stats;

    init();
    animate();

    function init() {

        container = document.body;

        camera = new THREE.PerspectiveCamera( 28, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.z = 100;

        scene = new THREE.Scene();

		light = new THREE.PointLight( 0xffffff, 1 );
		light.position.set( 3, 3, 3 );
		scene.add( light );
		scene.add( new THREE.AmbientLight( 0x404040 ) );

        source = new THREE.Mesh( new THREE.CubeGeometry( 1, 1, 1 ), new THREE.MeshLambertMaterial( { color: 0xffffff, wireframe: false }) );
        scene.add( source );
		scene.add( new THREE.FaceNormalsHelper( source ) );
		var axesHelper = new THREE.AxesHelper( 5 );
		scene.add( axesHelper );

		instObj = new THREE.Mesh( new THREE.SphereGeometry( 0.3, 32, 32 ), new THREE.MeshLambertMaterial( {color: 0x0000ff} ) );
		//new THREE.MeshPhysicalMaterial( {color: 0x0000ff, metalness: 1, roughness: 0.3, clearCoat: 1, clearCoatRoughness: 0, flatShading: true }) );
		instObj.translateX( 3 );
		scene.add( instObj );
		instObj.geometry.computeVertexNormals_New();

        stats = new Stats();
        container.appendChild( stats.dom );

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild( renderer.domElement );
		d3.select( renderer.domElement ).style( "position", "absolute" ).style( "top", 0 ).style( "left", 0 ).style( "z-index", -1 );

		particleSystem = new THREE.ParticleSystem( {
			size: 3,
			maxParticles: 10000,
			spawnRate: undefined,
			lifetime: 5,
			showOptions: true,
			instanceObject: instObj,
			//varyVelocity: 0,
			//initColour: {r:1,a:0.5},
			//varyColour: new THREE.Quaternion( 1, 0, 0, 0.3 ),
		});

		source.add( particleSystem );
		source.geometry.computeVertexNormals_New();
		particleSystem.buildOptions();
		force = new THREE.ForceCarrier( { mass: 10E9, type: 1, showHelper: true } );
		scene.add( force );
		particleSystem.assignForceCarrier( force );

        controls = new THREE.TrackballControls( camera, renderer.domElement );
        controls.rotateSpeed = 5.0;
        controls.zoomSpeed = 2.2;
        controls.panSpeed = 1;
        controls.dynamicDampingFactor = 0.3;

        window.addEventListener( 'resize', onWindowResize, false );

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function animate() {

        animID = requestAnimationFrame( animate );

        controls.update();

        particleSystem.update( );

        render();

        stats.update();

    }

	function pause() {

		animID && cancelAnimationFrame( animID );

	}

    function render() {

        renderer.render( scene, camera );

    }

    </script>
</body>
